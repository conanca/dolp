<script type="text/javascript">
$(function(){
	$("input:button,input:submit,input:reset").button();
	var userMap;
	
	$("#messageInboxList").jqGrid({
	   	rowNum:10,
	   	rowList:[10,20,30],
	   	autowidth: true,
	   	height: "100%",
	   	datatype: "json",
	    jsonReader:{
	   		repeatitems: false,
	   		userdata:"systemMessage"
        },
	    viewrecords: true,
	    caption:"收件箱消息列表",
	   	url:'system/message/getInboxGridData',
	   	colNames:['id','标题','发件人','日期','内容'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'title',index:'title', width:500},
	   		{name:'senderUserId',index:'senderUserId', width:200, editable:true},
	   		{name:'date',index:'date', width:200},
	   		{name:'content',index:'content', width:0,hidden:true}
	   	],
	   	pager: '#messageInboxPager',
	   	sortname: 'id',
	    sortorder: "asc",
	    multiselect: false,
	    loadComplete: function(data){
	    	//------------------设为同步模式------------------
	    	$.ajaxSetup({ async: false});
	    	var sendUserIdArr = new Array();
	    	var rows = data.rows;
	    	$.each(rows, function(index, row) {
	    		var id = row.senderUserId;
	    		if($.inArray(id,sendUserIdArr)==-1){
	    			sendUserIdArr.push(id);
	    		}
	    	});
	    	userMap = $.dolpGet('system/user/getUserMap/'+sendUserIdArr);
	    	var list = $(this)
	    	list.setColProp('senderUserId',{formatter:'select',edittype:'select',editoptions:{value:userMap}});
	    	list.clearGridData();
	    	$.each(rows, function(index, row) {
	    		list.addRowData(index,row);
	    	});
	    	$.ajaxSetup({ async: true});
	    	//------------------设回异步模式------------------
	    	$.addMessage($(this).getUserData());
	    },
	    onSelectRow: function(id) {
	    	var row = $(this).getRowData(id);
	    	// 显示消息详细内容，隐藏Grid
	    	$('#messageInboxDetailId').val(row.id);
	    	$('#messageInboxDetailTitle').text(row.title);
	    	$('#messageInboxDetailDate').text(row.date);
	    	$('#messageInboxDetailSender').text(userMap[row.senderUserId]);
	    	$('#messageInboxDetailContent').html(row.content);
	    	$(this).setGridState('hidden');
	    	$('#messageInboxDetail').show();
	    	// 设置该消息的已读标志
	    	$.dolpPost('system/message/readMessade',{messageId:row.id});
		}
	});
	$("#messageInboxList").setJqGridCUD('#messageInboxPager',{edit:false,add:false,del:false,search:false});

	$('#messageInboxDetail').hide();
	
	$('#messageInboxBack').click(function(){
		// 显示Grid，隐藏消息详细内容
		$("#messageInboxList").setGridState('visible');
		$('#messageInboxDetail').hide();
	});
	$('#messageInboxDelete').click(function(){
		var url = 'system/message/deleteReceivedMessage';
		var messageId = $('#messageInboxDetailId').val();
		$.dolpPost(url,{messageId:messageId});
		$("#messageInboxList").trigger('reloadGrid');
		$("#messageInboxList").setGridState('visible');
		$('#messageInboxDetail').hide();
	});
});
</script>

<table id="messageInboxList"></table>
<div id="messageInboxPager"></div>
<div id="messageInboxDetail">
	<input type="button" value="返回收件箱" id="messageInboxBack"/>
	<input type="button" value="删除" id="messageInboxDelete"/>
	<br/>
	<input type="hidden" id="messageInboxDetailId"/>
	<br/>
	<label id="messageInboxDetailTitle" class="messagetitle"></label>
	<fieldset>
		<table width="100%">
			<tr>
				<td>发件人:<label id="messageInboxDetailSender"></label></td>
				<td align="right">
					<label id="messageInboxDetailDate"></label>
				</td>
			</tr>
		</table>
		<div id="messageInboxDetailContent"></div>
	</fieldset>
</div>