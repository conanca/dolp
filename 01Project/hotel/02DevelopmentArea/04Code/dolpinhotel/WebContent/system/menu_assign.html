<script type="text/javascript">
$(function(){
	$("input:button,input:submit,input:reset").button();

	var roleId=0;
	
	$("#role1List").jqGrid({
	   	rowNum:10,
	   	rowList:[10,20,30],
	   	height: "100%",
	   	datatype: "json",
	    jsonReader:{
	   		repeatitems: false
        },
	    viewrecords: true,
	    loadComplete: function(){
			$.addMessage($(this).getUserData());
    	},
	    caption:"角色列表",
	   	url:'system/role/getGridData?isOrgaRela=0',
	   	colNames:['id','名称','描述'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'name',index:'name', width:100},
	   		{name:'description',index:'description', width:300}
	   	],
	   	pager: '#role1Pager',
	   	sortname: 'id',
	    sortorder: "asc",
    	onSelectRow: function(id){
    		roleId = id;
    		privilegeTreeSetting.asyncUrl = "system/menu/getPrivilegeByRoleId/"+roleId;
    		privilegeTree = $("#privilegeTreeUl").zTree(privilegeTreeSetting, zNodes);
        }
	});
	$("#role1List").navGrid('#role1Pager',{edit:false,add:false,del:false,search:false});

	var privilegeTreeSetting = {
		checkable: true,
		async: true,
		asyncUrl: "system/menu/getPrivilegeByRoleId/0",
		asyncParam: ["name", "id","lft","rgt","level"]
	};
	var zNodes =[];
	var privilegeTree = $("#privilegeTreeUl").zTree(privilegeTreeSetting, zNodes);

	$("#privilegeAssignBtn").click(function() {

		var checkedTreeNodes = privilegeTree.getCheckedNodes();
		var checkedMenus = [];
		var checkedPrivileges = [];
		var i = 0;
		var j = 0;
		$.each(checkedTreeNodes,function(index,value){
			if(value.lft){
				checkedMenus[i] = value.id;
				i++;
			}else{
				checkedPrivileges[j] = value.id;
				j++;
			}
		});

		var unCheckedTreeNodes = privilegeTree.getCheckedNodes(false);
		var unCheckedMenus = [];
		var unCheckedPrivileges = [];
		i = 0;
		j = 0;
		$.each(unCheckedTreeNodes,function(index,value){
			if(value.lft){
				unCheckedMenus[i] = value.id;
				i++;
			}else{
				unCheckedPrivileges[j] = value.id;
				j++;
			}
		});
		
		var url = "system/role/assignMenu";
		$.dolpPost(url,{roleId:roleId,checkedMenus:checkedMenus,checkedPrivileges:checkedPrivileges,unCheckedMenus:unCheckedMenus,unCheckedPrivileges:unCheckedPrivileges})
	});
});
</script>
<table>
	<tr>
		<td valign="top">
			<table id="role1List"></table>
			<div id="role1Pager"></div>
		</td>
		<td valign="top">
			<div>
				<ul id="privilegeTreeUl" class="tree"></ul>
			</div>
		</td>
		<td valign="top">
			<input type="button" value="分配" id="privilegeAssignBtn"/>
		</td>
	</tr>
</table>