<script src="js/i18n/jquery.localisation-min.js" type="text/javascript"></script>
<script src="js/ui.multiselect.js" type="text/javascript"></script>
<script type="text/javascript">
$(function(){
	$("#userBirthday").datepicker({yearRange: '1960:2000'});
	$("input:button,input:submit,input:reset").button();

	var userInfoIsEditFlag = false;

	//初始化用户信息界面
	$("#userInfo").dialog({ width: 520 , hide: 'slide' , modal: true , autoOpen: false , close: function(event, ui) {
			$("#userInfoId").attr("value",'');	//清空隐藏域的值
			$("#userInfoOrganizationId").attr("value",'');	//清空隐藏域的值
			$('#userInfoForm')[0].reset();	//清空表单的值
		}
	});
	//初始化用户角色分配界面
	$("#roleAssignInfo").dialog({ width: 500 , height: 320 , hide: 'slide' , modal: true , autoOpen: false , close: function(event, ui) {
			//关闭后全部取消选中
			$("#roleIds option").each(function(){
				if($(this).attr("selected") == true){
					$(this).removeAttr("selected");
				}
			});
		}
	});
	//初始化用户岗位分配界面
	$("#postAssignInfo").dialog({ width: 650 , hide: 'slide' , modal: true , autoOpen: false, close: function(event, ui) {
		//关闭后刷新tree和grid
		userPostOrganizationTree.reAsyncChildNodes(null, "refresh");
		$("#userPostList").setGridParam({url:"system/role/getUserPost",page:1});
		$("#userPostList").trigger('reloadGrid');
	}
});
	
	//------------------设为同步模式------------------
	$.ajaxSetup({ async: false});
	//初始化性别下拉列表框
	var genders = $.getSysEmnuItem("gender");
	var genders1 = $.swapJSON(genders); 
	$("#user_manage_gender").addItems(genders);
	$.ajaxSetup({ async: true});
	//------------------设回异步模式------------------

	//设置Grid
	$("#userInfoList").jqGrid({
		rowNum:10,
	   	rowList:[10,20,30],
	   	autowidth: true,
	   	height: "100%",
	    datatype: "json",
	    jsonReader:{
	   		repeatitems: false
        },
	    viewrecords: true,
	    loadComplete: function(){
			$.addMessage($(this).getUserData());
    	},
        caption: "用户列表",
	   	url:'system/user/getGridData',
	   	editurl: "system/user/deleteRow",
	   	colNames:['id','登录号', '姓名','性别','年龄','生日','电话号码','organizationId'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'number',index:'number', width:100},
	   		{name:'name',index:'name', width:100},
	   		{name:'gender',index:'gender', width:100,resizable:false, edittype:'select', formatter:'select', editoptions:{value:genders1}},//不可调整宽度
	   		{name:'age',index:'age', width:100, editable:true},
	   		{name:'birthday',index:'birthday', width:100},
	   		{name:'phone',index:'phone', width:150},
	   		{name:'organizationId',index:'organizationId', width:0,hidden:true}
	   	],
	   	pager: '#userInfoPager',
	   	sortname: 'number',
	    sortorder: "asc",
	    multiselect: true
	});
	//不显示jqgrid自带的增删改查按钮
	$("#userInfoList").navGrid('#userInfoPager',{edit:false,add:false,del:false,search:false});
	//添加自定义按钮——添加、编辑和删除
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"添加",buttonicon:"ui-icon-plus",
		onClickButton:function(){
			userInfoIsEditFlag = false;
			$("#userInfo").dialog( "open" );
			var url = "system/user/getNewUserNumber";
			//------------------设为同步模式------------------
			$.ajaxSetup({ async: false});
			var newUserNumber = $.dolpPost(url);
			$("#userInfoNumber").val(newUserNumber);
			$.ajaxSetup({ async: true});
			//------------------设回异步模式------------------
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"编辑",buttonicon:"ui-icon-pencil",
		onClickButton:function(){
			userInfoIsEditFlag = true;
			var id = $(this).getGridParam('selrow');
			if (id) {
				$(this).GridToForm(id,"#userInfoForm");
				$("#userInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择要编辑的记录",null);
			}
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"删除",buttonicon:"ui-icon-trash",
		onClickButton:function(){
			var gr = $(this).getGridParam('selarrrow');
			if( gr != null && gr != ''){
				$(this).delGridRow(gr,{reloadAfterSubmit:true,
	                afterSubmit: function(xhr, postdata) {
	                    $.addMessage($.parseJSON(xhr.responseText).userdata);
	                    return [true];
                }});
			}
			else{
				$.addMessageStr(null,"请选择要删除的记录",null);
			}
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"角色",buttonicon:"ui-icon-person",
		onClickButton:function(){
			userInfoIsEditFlag = true;
			var id = $(this).getGridParam('selrow');
			if (id) {
				$("#assigningUserID").val(id);
			
				$("#roleIds option").each(function(){
					if($(this).attr("selected") == true){
						$(this).removeAttr("selected");
					}
				});
	
				//------------------设为同步模式------------------
				$.ajaxSetup({ async: false});
				var currentRole = $.getItem("system/user/getCurrentRoleIDs/"+id);
				$.each(currentRole,function(index,value){
					$("#roleIds option[value='"+value+"']").attr("selected",true);
				});
				$.ajaxSetup({ async: true});
				//------------------设回异步模式------------------
				
				$("#roleIds").multiselect("destroy");
				$("#roleIds").multiselect();
				
				$("#roleAssignInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择用户",null);
			}
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"岗位",buttonicon:"ui-icon-person",position:"last",
		onClickButton:function(){
			var id = $(this).getGridParam('selrow');
			if (id) {
				roleId = id;
				$("#postAssignInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择用户",null);
			}
		}
	});

	//查询按钮点击事件
	$("#userInfo_search_btn").click(function () { 
		var number = $("#userInfo_search_number").val();
		var name = $("#userInfo_search_name").val();
		url = "system/user/getGridData?number="+number+"&name="+name;
		$("#userInfoList").setGridParam({url:url, page:1}).trigger("reloadGrid");
    });

	//------------------设为同步模式------------------
	$.ajaxSetup({ async: false});
	$("#roleIds").addItems($.getItem("system/role/getAllRole?isOrgaRela=0"));
	$.ajaxSetup({ async: true});
	//------------------设回异步模式------------------
	
	jQuery.validator.addMethod("numberIsDuplicate", function(value) {
		//编辑时，不check
		if(userInfoIsEditFlag){
			return true;
		}
		var url = "system/user/userNumberIsDuplicate/"+value;
		//------------------设为同步模式------------------
		$.ajaxSetup({ async: false});
		var userNumberIsDuplicate = $.dolpPost(url);
		$.ajaxSetup({ async: true});
		//------------------设回异步模式------------------
		if(userNumberIsDuplicate == true)
		{
			return false;
		} else {
			return true;
		}
	},"系统中已存在相同的用户编号！");

	// 验证
	$("#userInfoForm").validate({
		rules: {
			number: {
				required: true,
				number: true,
				minlength: 4,
				maxlength: 4,
				numberIsDuplicate :true
			},
			name: {
				required: true,
				maxlength: 10
			},
			password: {
				required: true,
				maxlength: 20,
				minlength: 3
			},
			password_again: {
				required: true,
				maxlength: 20,
				minlength: 3,
				equalTo: "#password1"
			},
			gender: "required",
			age: {
				digits: true,
				maxlength: 3
			},
			birthday: {
				date: true
			}
		},
		errorPlacement: function(error, element) {
			$('<br/>').appendTo(element.parent());
			error.appendTo(element.parent());
		}
	});

	//点击保存时提交
	$('#userInfoForm').submit(function() {
		$.blockUI();
		if($(this).valid()){
			//关闭用户信息界面
			$("#userInfo").dialog( "close" );
			var url = 'system/user/save';
			var userInfo = $(this).serializeObject();
			//------------------设为同步模式------------------
			$.ajaxSetup({ async: false});
			$.dolpPost(url,userInfo);
			//刷新表格
			$('#userInfoList').trigger("reloadGrid");
			$.ajaxSetup({ async: true});
			//------------------设回异步模式------------------
		}else{
			$.addMessageStr(null,"未通过验证",null);
		}
		$.unblockUI();
		return false;
	});

	//点击取消时关闭对话框
	$("#userInfocancel").click(function() {
		$("#userInfo").dialog( "close" );
	});

	$('#roleAssignForm').submit(function() {
		$.blockUI();
		//关闭用户角色分配界面
		$("#roleAssignInfo").dialog( "close" );
		var url = 'system/user/assignRole';
		var roleAssignFormInfo = $(this).serializeObject();
		$.dolpPost(url,roleAssignFormInfo);
		$.unblockUI();
		return false;
	});

	var userPostOrganizationTreeSetting = {
			checkable: false,
			async: true,
			asyncUrl: "system/organization/getNodes",
			asyncParam: ["name", "id"],
			callback:{
				beforeClick: function(treeId, treeNode){
					var userId = $("#userInfoList").getGridParam('selrow');
					$("#userPostList").setGridParam({url:"system/role/getUserPost?userId="+userId+"&organizationId="+treeNode.id,page:1});
					$("#userPostList").trigger('reloadGrid');
				}
			}
		};
	var userPostOrganizationTree = $("#userPostOrganizationTreeUl").zTree(userPostOrganizationTreeSetting);

	$("#userPostList").jqGrid({
	   	rowNum:10,
	   	rowList:[10,20,30],
	   	autowidth: true,
	   	height: "100%",
	   	datatype: "json",
	    viewrecords: true,
	    loadComplete: function(){
			$.addMessage($(this).getUserData());
    	},
	    caption:"岗位列表",
	   	url:'system/role/getUserPost',
	   	colNames:['id','名称','描述','已分配'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'name',index:'name', width:150},
	   		{name:'description',index:'name', width:280},
	   		{name:'isset',index:'isset', width:50, align:'center', formatter:'checkbox', formatoptions:{disabled:false}}
	   	],
	   	pager: '#userPostPager',
	   	sortname: 'id',
	    sortorder: "asc",
	    multiselect: false
	});
	$("#userPostList").setJqGridCUD('#userPostPager',{edit:false,add:false,del:false,search:false});

	$("#postAssignBtn").click(function() {
		var selectedPost = $("#userPostList").getCol('isset',true);
		var selectedPostIds = new Array();;
		var i=0;
        $.each(selectedPost, function(k, v) {
            if(v.value=='Yes'){
            	selectedPostIds[i]=v.id;
				i++;
            }
        });
		var url = "system/user/assignPost";
		var userId = $("#userInfoList").getGridParam('selrow');
		var orgId = userPostOrganizationTree.getSelectedNode().id;
		$.dolpPost(url,{userId:userId,orgId:orgId,selectedPostIds:selectedPostIds})
	});
	
});
</script>

<fieldset>
<legend>用户查询</legend>
<table>
	<tr>
		<td>
			用户编号：
		</td>
		<td>
			<input type="text" name="number" id="userInfo_search_number"/>
		</td>
		<td>
			用户姓名：
		</td>
		<td>
			<input type="text" name="name" id="userInfo_search_name"/>
		</td>
	</tr>
	<tr>
		<td colspan="4" align="right">
			<input type="button" id="userInfo_search_btn" value="查询"/>
		</td>
	</tr>
</table>
</fieldset>
<br/>
<table id="userInfoList"></table>
<div id="userInfoPager"></div>

<div id="userInfo" title="用户信息">
	<form id="userInfoForm" action="#">
	<table>
		<tr>
			<td>
				用户编号：
			</td>
			<td>
				<input type="hidden" name="id" id="userInfoId"/>
				<input type="hidden" name="organizationId" id="userInfoOrganizationId"/>
				<input type="text" name="number" id="userInfoNumber"/>
			</td>
			<td>
				用户姓名：
			</td>
			<td>
				<input type="text" name="name"/>
			</td>
		</tr>
		<tr>
			<td>
				登录密码：
			</td>
			<td>
				<input type="password" name="password" id="password1"/>
			</td>
			<td>
				再次输入密码：
			</td>
			<td>
				<input type="password" name="password_again"/>
			</td>
		</tr>
			<tr>
			<td>
				性别：
			</td>
			<td>
				<select name="gender" id="user_manage_gender">
					<option value="">请选择</option>
				</select>
			</td>
			<td>
				年龄：
			</td>
			<td>
				<input type="text" name="age"/>
			</td>
		</tr>
		<tr>
			<td>
				出生日期：
			</td>
			<td>
				<input type="text" name="birthday" id="userBirthday"/>
			</td>
			<td>
				电话号码：
			</td>
			<td>
				<input type="text" name="phone"/>
			</td>
		</tr>
		<tr>
			<td colspan="4" align="center">
				<input type="submit" value="保存"/>
				<input type="reset" value="重置"/>
				<input id="userInfocancel" type="button" value="取消"/>
			</td>
		</tr>
	</table>
	</form>
</div>

<div id="roleAssignInfo" title="角色分配信息">
	<form id="roleAssignForm" action="#">
		<input type="submit" value="分配"/>
		<input type="hidden" name="userId" id="assigningUserID"/>
		<select id="roleIds" name="assignedRoleIds[]" class="multiselect" multiple="multiple" size="6">
		</select>
	</form>
</div>

<div id="postAssignInfo" title="岗位分配信息">
	<table width='100%'>
		<tr>
			<td valign="top" width="15%">
				<div>
					<ul id="userPostOrganizationTreeUl" class="tree"></ul>
				</div>
			</td>
			<td style="border-left: 1px dashed #CCCCCC;">&nbsp;</td>
			<td valign="top">
				<input type="button" value="分配" id="postAssignBtn"/>
				<table id="userPostList"></table>
				<div id="userPostPager"></div>
			</td>
		</tr>
	</table>
</div>