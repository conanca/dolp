<script type="text/javascript">
$(function(){
	$(".datepicker").datepicker();
	$("input:button,input:submit,input:reset").button();
	
	//获取所有已入住房间的房间号-房间Id键值对
	var url3 = "dolpinhotel/setup/room/getAllRoomForSelectOption";
	//------------------设为同步模式------------------
	$.ajaxSetup({ async: false});
	var allRooms = $.dolpPost(url3);
	$.ajaxSetup({ async: true});
	//------------------设回异步模式------------------
	
	$("#billList").jqGrid({
		rowNum:10,
	   	rowList:[10,20,30],
	   	autowidth: true,
	   	height: "100%", //自动调整高度(无滚动条)
		datatype: "json",
	   	jsonReader:{
	   		repeatitems: false
        },
	    viewrecords: true,
	    loadComplete: function(){
			$.addMessage($(this).getUserData());
    	},
	    caption: "账单列表",
	   	url:'dolpinhotel/management/bill/getGridData',
	    editurl: "dolpinhotel/management/bill/editRow",	//del:true
	   	colNames:['id','账单号', '金额','日期'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'number',index:'number', width:100, editable:true},
	   		{name:'amount',index:'amount', width:100, editable:true},
	   		{name:'date',index:'date', width:120, editable:true, sorttype:'date', formatter:fmtDate},
	   	],
	   	pager: '#billPager',
	   	sortname: 'number',
	    sortorder: "asc",
	    multiselect: false,
		onSelectRow: function(id) {
			$("#billSubList").setGridParam({url:"dolpinhotel/management/roomoccupancy/getGridData?billId="+id,page:1});
			$("#billSubList").trigger('reloadGrid');
		}
	});
	//开启jqgrid自带的删改功能
	$("#billList").navGrid('#billPager',{edit:true,add:false,del:true,search:false},
		{
			reloadAfterSubmit:true,
			afterSubmit: function(xhr, postdata) {
				$.addMessage($.parseJSON(xhr.responseText).userdata);
				return [true];
			}
		},
		{},
		{
			reloadAfterSubmit:true,
			afterSubmit: function(xhr, postdata) {
				//刷新表格billSubList
				$('#billSubList').trigger("reloadGrid");
				$.addMessage($.parseJSON(xhr.responseText).userdata);
				return [true];
			}
		},
		{},{}
	);

	$("#billSubList").jqGrid({
	   	rowNum:10,
	   	rowList:[10,20,30],
	   	autowidth: true,
	   	height: "100%", //自动调整高度(无滚动条)
	   	datatype: "json",
		jsonReader:{
	   		repeatitems: false
		},
		viewrecords: true,
	    loadComplete: function(){
			$.addMessage($(this).getUserData());
    	},
		caption: "房间入住情况列表",
	   	url:'dolpinhotel/management/roomoccupancy/getGridData?status=3',
	   	colNames:['id','房间号', '入住日期','预离日期','离开日期','入住天数','金额','状态','billId'],
	   	colModel:[
	   		{name:'id',index:'id', width:0,hidden:true},
	   		{name:'roomId',index:'roomId', width:100,formatter:'select', editoptions:{value:allRooms}},
	   		{name:'enterDate',index:'enterDate', width:120, editable:true, formatter:fmtDate },
	   		{name:'expectedCheckOutDate',index:'expectedCheckOutDate',width:120, editable:true, formatter:fmtDate},
	   		{name:'leaveDate',index:'leaveDate', width:120, editable:true, formatter:fmtDate},
	   		{name:'occupancyDays',index:'occupancyDays', width:120},
	   		{name:'amount',index:'amount', width:100},
	   		{name:'status',index:'status', width:100,formatter:'select', editoptions:{value:"0:入住中;1:已离开"},hidden:true},
	   		{name:'billId',index:'billId', width:0,hidden:true}
	   	],
	   	pager: '#billSubPager',
	   	sortname: 'id',
		sortorder: "desc",
		multiselect: false
	});
	//不显示jqgrid自带的增删改查按钮
	$("#billSubList").navGrid('#billSubPager',{edit:false,add:false,del:false,search:false});

	//查询按钮点击事件
	$("#bill_manage_search_btn").click(function () { 
		var number = $("#bill_manage_number").val();
		var amount = $("#bill_manage_amount").val();
		var dateFrom = $("#bill_manage_dateFrom").val();
		var dateTo = $("#bill_manage_dateTo").val();
		var url = "dolpinhotel/management/bill/getGridData?number="+number+"&amount="+amount+"&dateFrom="+dateFrom+"&dateTo="+dateTo;
		$("#billList").setGridParam({url:url,page:1}).trigger("reloadGrid");
    });
});

function fmtDate(value){
	if(value){
		return value.substr(0,10);
	}else{
		return '';
	}
}
</script>

<fieldset>
<legend>账单查询</legend>
<table>
	<tr>
		<td>
			账单号：
		</td>
		<td>
			<input type="text" id="bill_manage_number"/>
		</td>
		<td>
			金额：
		</td>
		<td>
			<input type="text" id="bill_manage_amount"/>
		</td>
	</tr>
	<tr>
		<td>
			日期：
		</td>
		<td colspan="3">
			<input type="text" id="bill_manage_dateFrom" class="datepicker"/>
			-
			<input type="text" id="bill_manage_dateTo" class="datepicker"/>
		</td>
	</tr>
	<tr>
		<td colspan="4" align="right">
			<input type="button" id="bill_manage_search_btn" value="查询"/>
		</td>
	</tr>
</table>
</fieldset>
<br/>
<table id="billList"></table>
<div id="billPager"></div>
<br/>
<table id="billSubList"></table>
<div id="billSubPager"></div>