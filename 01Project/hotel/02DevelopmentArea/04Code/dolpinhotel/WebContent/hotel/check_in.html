<script src="js/jquery-ui-timepicker-addon.js" type="text/javascript"></script>
<script src="js/jquery.selectsubcategory.js" type="text/javascript"></script>
<script type="text/javascript">
$(function(){
	$(".datepicker").datetimepicker({timeFormat: 'hh:mm:ss'});
	$("input:button,input:submit,input:reset").button();

	//------------------设为同步模式------------------
	$.ajaxSetup({ async: false});

	//初始化性别下拉列表框
	var genders = $.swapJSON($.getSysEmnuItem("gender"));
	var certificateTypes = $.swapJSON($.getSysEmnuItem("certificateType"));
	// 通过插件jquery.selectsubcategory.js实现下拉框二级联动
	$("#roomTypeSelector").addItems($.dolpGet("dolpinhotel/setup/roomtype/getAllRoomTypeMap"));
	$("#roomTypeSelector").selectSubcategory({
		url: 'dolpinhotel/setup/room/getAllAvailableRoomForSelectOption',
		subcategoryid: 'roomSelector'
	});

	$.ajaxSetup({ async: true});
	//------------------设回异步模式------------------

	$("#customerList").jqGrid({
		datatype: "local",
		viewrecords: false,
		caption:"顾客信息列表",
		editurl: 'doNothing',	// 存在的但是不作任何事情的url,用于 CRUD on Local Data
		colNames:['姓名','性别','证件类型','证件号码','籍贯地址'],
		colModel:[
			{name:'name',index:'name', width:80,editable:true,editrules:{required:true}},
			{name:'gender',index:'gender', width:80, editable:true, edittype:'select', formatter:'select', editoptions:{value:genders}},
			{name:'certificateType',index:'certificateType', width:120, editable:true, edittype:'select', formatter:'select', editoptions:{value:certificateTypes}},
			{name:'credentialNumber',index:'credentialNumber', width:150,editable:true,editrules:{required:true}},
			{name:'address',index:'address', width:300,editable:true}
		],
		pager: '#customerPager'
	});
	//不显示查询按钮
	$("#customerList").navGrid('#customerPager',{edit:true,add:true,del:true,search:false});

	// 验证
	$("#roomOccupancyForm").validate({
		rules: {
			roomType: {
				required: true
			},
			roomId: {
				required: true
			},
			enterDate: {
				required: true
			}
		}
	});

	$("#roomcheckin").click(function() {
		if(!$("#roomOccupancyForm").valid()){
			$.addMessageStr(null,"未通过验证",null);
			return false;
		}
		var url='dolpinhotel/management/roomoccupancy/saveRoomOccupancy';
		var enterDate=$('input:text[name=enterDate]').val();
		var expectedCheckOutDate=$('input:text[name=expectedCheckOutDate]').val();
		var roomId=$('select[name=roomId]').val();
		var customers =$.toJSON($("#customerList").getRowData());
		$.dolpPost(url, { customers: customers, enterDate: enterDate, expectedCheckOutDate: expectedCheckOutDate, roomId: roomId });

		$('input:text[name=enterDate]').val("");
		$('input:text[name=expectedCheckOutDate]').val("");
		//移除房间号选择框的所有option
		$('#roomSelector').find('option').remove().end();
		$("#roomSelector").append(new Option("请先选择房间类型",""));
		$("#roomTypeSelector").val("");
		$("#customerList").clearGridData();
	});
});
</script>
<div id="roomOccupancyDiv" title="房间登记情况">
	<form id="roomOccupancyForm" action="#">
		<fieldset>
		<legend>入住信息</legend>
		<table>
			<tr>
				<td>
					入住日期：
				</td>
				<td>
					<input type="text" name="enterDate" class="datepicker"/>
				</td>
				<td>
					预离日期：
				</td>
				<td>
					<input type="text" name="expectedCheckOutDate" class="datepicker"/>
				</td>
			</tr>
			<tr>
				<td>
					房间类型：
				</td>
				<td>
					<select name="roomType" id="roomTypeSelector">
						<option value="">请选择</option>
					</select>
				</td>
				<td>
					房间号：
				</td>
				<td>
					<select name="roomId" id="roomSelector">
						<option value="">请先选择房间类型</option>
					</select>
				</td>
			</tr>
		</table>
		<br/>
		<table id="customerList"></table>
		<div id="customerPager"></div>
		</fieldset>
		<br/>
		<div>
			<input type="button" value="登记" id="roomcheckin"/>
			<input type="reset" value="重置"/>
		</div>
	</form>
</div>