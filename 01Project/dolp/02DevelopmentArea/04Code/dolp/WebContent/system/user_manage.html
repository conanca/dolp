<script src="js/i18n/jquery.localisation-min.js" type="text/javascript"></script>
<script src="js/ui.multiselect.js" type="text/javascript"></script>
<script type="text/javascript">
$(function(){
	$("input:button,input:submit,input:reset").button();

	// 填充选择框roleIds的值
	$.dolpGet("system/role/getAllRoleMap/false",null,function(returnData){
		$("#roleIds").addItems(returnData);
	});
	
	$.localise('ui-multiselect', {language: 'zh', path: 'js/i18n/'});
	$(".multiselect").multiselect();

	//初始化用户角色分配界面
	$("#roleAssignInfo").dialog({ width: 500 , height: 330 , hide: 'slide' , modal: true , autoOpen: false , close: function(event, ui) {
			//关闭后全部取消选中
			$("#roleIds option:selected").each(function(){
				$(this).removeAttr("selected");
			});
		}
	});
	//初始化用户岗位分配界面
	$("#postAssignInfo").dialog({ width: 650 , hide: 'slide' , modal: true , autoOpen: false, close: function(event, ui) {
			//关闭后刷新tree和grid
			userPostOrganizationTree.reAsyncChildNodes(null, "refresh");
			$("#userPostList").setGridParam({url:"system/role/getUserPostGridData",page:1});
			$("#userPostList").trigger('reloadGrid');
		}
	});
	//初始化修改用户密码界面
	$("#userPasswordChangeInfo").dialog({ width: 300 , hide: 'slide' , modal: true , autoOpen: false, close: function(event, ui) {
			//关闭后清空表单的旧值
			$('#userMangeChangePwdForm')[0].reset();
			$("#userMangeChangePwdForm_userId").val('');
		}
	});

	//设置Grid
	$("#userInfoList").jqGrid({
		jsonReader:{
			repeatitems: false
		},
		caption: "用户列表",
		url:'system/user/getGridData',
		editurl: "system/user/editRow",
		colNames:['id','用户编号', '姓名','性别','年龄','生日','电话号码','organizationId'],
		colModel:[
			{name:'id',index:'id', width:0,editable:true,hidden:true},
			{name:'number',index:'number', width:100,editable:true,editrules:{required:true,minValue:1000,maxValue:9999},formoptions:{elmsuffix:' <font color="red">*</font>'},
				// 新增时，自动填充number的值为新的用户号
				editoptions:{dataInit:function (elem) {
						$(elem).focus(function(){
							if($(elem).val()==''){
								$.dolpGet("system/user/getNewUserNumber",null,function(returnData){
									$(elem).val(returnData);
								});
							}
						});
					}
				}
			},
			{name:'name',index:'name', width:100,editable:true,editrules:{required:true},formoptions:{elmsuffix:' <font color="red">*</font>'}},
			{name:'gender',index:'gender', width:100,editable:true,edittype:'select', formatter:'select', editoptions:{value:genders1}},
			{name:'age',index:'age', width:100,editable:true,editrules:{required:true,integer:true},formoptions:{elmsuffix:' <font color="red">*</font>'}},
			{name:'birthday',index:'birthday', width:100,editable:true,sorttype:'date',
				editoptions:{size:12, dataInit:function(el){
						$(el).datepicker({dateFormat:'yy-mm-dd'});
					}
				},
				formoptions:{elmsuffix:" yyyy-mm-dd" }
			},
			{name:'phone',index:'phone', width:150,editable:true},
			{name:'organizationId',index:'organizationId', width:0,editable:true,hidden:true}
		],
		pager: '#userInfoPager',
		sortname: 'number',
		sortorder: "asc",
		multiselect: true
	});
	//不显示jqgrid自带的查询按钮
	$("#userInfoList").setJqGridCUD('#userInfoPager',{edit:true,add:true,del:true,search:false});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"角色",buttonicon:"ui-icon-person",
		onClickButton:function(){
			var id = $(this).getGridParam('selrow');
			if (id) {
				$("#assigningUserID").val(id);
				
				// 全部取消选中 选择框roleIds的值
				$("#roleIds option").each(function(){
					if($(this).attr("selected") == true){
						$(this).removeAttr("selected");
					}
				});

				// 指定选中的选择框roleIds的值
				$.dolpGet("system/user/getCurrentRoleIDs/"+id,null,function(returnData){
					var currentRole = returnData;
					$.each(currentRole,function(index,value){
						$("#roleIds option[value='"+value+"']").attr("selected","selected");
						// TODO 由于multiselect插件的bug,改变选择框元素的属性时，需重新载入插件
						$("#roleIds").multiselect("destroy");
						$("#roleIds").multiselect();
					});
				});

				$("#roleAssignInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择用户",null);
			}
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"岗位",buttonicon:"ui-icon-flag",position:"last",
		onClickButton:function(){
			var id = $(this).getGridParam('selrow');
			if (id) {
				roleId = id;
				$("#postAssignInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择用户",null);
			}
		}
	});
	$("#userInfoList").navButtonAdd('#userInfoPager',{caption:"修改密码",buttonicon:"ui-icon-key",position:"last",
		onClickButton:function(){
			var id = $(this).getGridParam('selrow');
			if (id) {
				$("#userMangeChangePwdForm_userId").val(id);
				$("#userPasswordChangeInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择用户",null);
			}
		}
	});
	//添加自定义按钮——导出Excel
	$("#userInfoList").export2Excel('#userInfoPager');

	//查询按钮点击事件
	$("#userInfoSerchForm").submit(function() {
		var number = $("#userInfo_search_number").val();
		var name = $("#userInfo_search_name").val();
		url = "system/user/getGridData?number="+number+"&name="+name;
		$("#userInfoList").setGridParam({url:url, page:1}).trigger("reloadGrid");
		return false;
	});

	$('#roleAssignForm').submit(function() {
		//关闭用户角色分配界面
		$("#roleAssignInfo").dialog( "close" );
		var url = 'system/user/assignRole';
		var roleAssignFormInfo = $(this).serializeObject();
		$.dolpPost(url,roleAssignFormInfo);
		return false;
	});
	
	$("#roleAssignInfoCancelbtn").click(function() {
		$('#roleAssignInfo').dialog( "close" );
	});

	var userPostOrganizationTreeSetting = {
			async: {
				enable: true,
				url: "system/organization/getNodes",
				dataFilter: ajaxDataFilter,
				autoParam:["name", "id"]
			},
			callback:{
				beforeClick: function(treeId, treeNode){
					var userId = $("#userInfoList").getGridParam('selrow');
					$("#userPostList").setGridParam({url:"system/role/getUserPostGridData?userId="+userId+"&organizationId="+treeNode.id,page:1});
					$("#userPostList").trigger('reloadGrid');
				}
			}
		};
	$.fn.zTree.init($("#userPostOrganizationTreeUl"), userPostOrganizationTreeSetting);
	var userPostOrganizationTree = $.fn.zTree.getZTreeObj("userPostOrganizationTreeUl");

	$("#userPostList").jqGrid({
		caption:"岗位列表",
		url:'system/role/getUserPostGridData',
		colNames:['id','名称','描述','已分配'],
		colModel:[
			{name:'id',index:'id', width:0,hidden:true},
			{name:'name',index:'name', width:150},
			{name:'description',index:'name', width:280},
			{name:'isset',index:'isset', width:50, align:'center', formatter:'checkbox', formatoptions:{disabled:false}}
		],
		pager: '#userPostPager',
		sortname: 'id',
		sortorder: "asc",
		multiselect: false
	});
	$("#userPostList").setJqGridCUD('#userPostPager',{edit:false,add:false,del:false,search:false});

	$("#postAssignBtn").click(function() {
		var selectedPost = $("#userPostList").getCol('isset',true);
		var selectedPostIds = new Array();
		var i=0;
		$.each(selectedPost, function(k, v) {
			if(v.value=='Yes'){
				var row = $("#userPostList").getRowData(v.id);
				selectedPostIds[i]=row.id;
				i++;
			}
		});
		var url = "system/user/assignPost";
		var userId = $("#userInfoList").getGridParam('selrow');
		var orgId = userPostOrganizationTree.getSelectedNode().id;
		$.dolpPost(url,{userId:userId,orgId:orgId,selectedPostIds:selectedPostIds})
	});
	
	$("#postAssignInfoCancelbtn").click(function() {
		$('#postAssignInfo').dialog( "close" );
	});

	// 验证
	$("#userMangeChangePwdForm").validate({
		rules: {
			newPassword: {
				required: true,
				maxlength: 20,
				minlength: 3
			},
			password_again: {
				required: true,
				maxlength: 20,
				minlength: 3,
				equalTo: "#userMangeChangePwdForm_Password1"
			}
		},
		errorPlacement: function(error, element) {
			$('<br/>').appendTo(element.parent());
			error.appendTo(element.parent());
		}
	});
	
	//点击保存时提交
	$('#userMangeChangePwdForm').submit(function() {
		if($(this).valid()){
			var changePwdInfo = $(this).serializeObject();
			$.dolpPost('system/user/changeUserPassword',changePwdInfo);
		}else{
			$.addMessageStr(null,"未通过验证",null);
		}
		$("#userPasswordChangeInfoCancelbtn").click();
		return false;
	});
	
	$("#userPasswordChangeInfoCancelbtn").click(function() {
		$('#userPasswordChangeInfo').dialog( "close" );
	});
	
	$("#userImportFileUploadBtn").click(function() {
		$("#userImportFile").dolpUpload('system/user/importUsers');
	});
});
</script>

<fieldset>
<legend>用户查询</legend>
<form id="userInfoSerchForm" action="#">
<table>
	<tr>
		<td>
			用户编号：
		</td>
		<td>
			<input type="text" name="number" id="userInfo_search_number"/>
		</td>
		<td>
			姓名：
		</td>
		<td>
			<input type="text" name="name" id="userInfo_search_name"/>
		</td>
	</tr>
	<tr>
		<td colspan="4" align="right">
			<input type="submit" value="查询"/>
		</td>
	</tr>
</table>
</form>
</fieldset>
<br/>

<fieldset>
<legend>用户导入</legend>
	<input type="file" name="userImportFile" id="userImportFile"/><br/>
	<button id="userImportFileUploadBtn">上传导入</button>
</fieldset>
<br/>

<table id="userInfoList"></table>
<div id="userInfoPager"></div>

<div id="roleAssignInfo" title="角色分配信息">
	<form id="roleAssignForm" action="#">
		<p>
			<input type="submit" value="分配"/>
			&nbsp;&nbsp;&nbsp;
			<input type="button" value="取消" id='roleAssignInfoCancelbtn'/>
		</p>
		<input type="hidden" name="userId" id="assigningUserID"/>
		<select id="roleIds" name="assignedRoleIds[]" class="multiselect" multiple="multiple" size="6">
		</select>
	</form>
</div>

<div id="postAssignInfo" title="岗位分配信息">
	<table width='100%'>
		<tr>
			<td valign="top" width="15%">
				<div>
					<ul id="userPostOrganizationTreeUl" class="ztree"></ul>
				</div>
			</td>
			<td style="border-left: 1px dashed #CCCCCC;">&nbsp;</td>
			<td valign="top">
				<p>
					<input type="button" value="分配" id="postAssignBtn"/>
					&nbsp;&nbsp;&nbsp;
					<input type="button" value="取消" id='postAssignInfoCancelbtn'/>
				</p>
				<table id="userPostList"></table>
				<div id="userPostPager"></div>
			</td>
		</tr>
	</table>
</div>

<div id="userPasswordChangeInfo" title="修改用户密码">
	<form id="userMangeChangePwdForm" action="#">
		<table>
			<tr>
				<td>新密码：</td>
				<td>
					<input type="hidden" name="userId" id="userMangeChangePwdForm_userId"/>
					<input type="password" name="newPassword" id="userMangeChangePwdForm_Password1"/>
				</td>
			</tr>
			<tr>
				<td>再次输入新密码：</td>
				<td><input type="password" name="password_again"/></td>
			</tr>
		</table>
		<p align="center">
			<input type="submit" value="修改"/>
			&nbsp;&nbsp;&nbsp;
			<input type="reset" value="重置"/>
			&nbsp;&nbsp;&nbsp;
			<input type="button" value="取消" id='userPasswordChangeInfoCancelbtn'/>
		</p>
	</form>
</div>