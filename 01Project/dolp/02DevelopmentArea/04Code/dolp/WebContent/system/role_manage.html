<script type="text/javascript">
$(function(){
	var roleId=0;
	$("#roleList").jqGrid({
		jsonReader:{
			repeatitems: false
		},
		caption:"角色列表",
		url:'system/role/getGridData?isOrgaRela=false',
		editurl:"system/role/editRow",
		colNames:['id','名称','描述','isOrgaRela'],
		colModel:[
			{name:'id',index:'id', width:0,editable:true,hidden:true},
			{name:'name',index:'name', width:100,editable:true,editrules:{required:true},formoptions:{elmsuffix:' <font color="red">*</font>'}},
			{name:'description',index:'description', width:300,editable:true,edittype:"textarea"},
			{name:'isOrgaRela',index:'isOrgaRela', width:0,hidden:true,editable:true,editoptions:{defaultValue:false}}
		],
		pager: '#rolePager',
		sortname: 'id',
		sortorder: "asc",
		multiselect: true
	});
	$("#roleList").setJqGridCUD('#rolePager',{edit:true,add:true,del:true,search:false});
	//添加自定义按钮——权限分配
	$("#roleList").navButtonAdd('#rolePager',{caption:"权限分配",buttonicon:"ui-icon-key",
		onClickButton:function(){
			var id = $(this).getGridParam('selrow');
			if (id) {
				roleId = id;
				privilegeTree.setting.async.url = "system/menu/getPrivilegeNodesByRoleId/"+roleId;
				privilegeTree.reAsyncChildNodes(null, "refresh");
				$("#privilegeInfo").dialog( "open" );
			} else {
				$.addMessageStr(null,"请选择角色",null);
			}
		}
	});
	//添加自定义按钮——导出Excel
	$("#roleList").export2Excel('#rolePager');

	//初始化权限信息界面
	$("#privilegeInfo").dialog({ width: 250 , hide: 'slide' , modal: true , autoOpen: false});
	//定义权限树
	var privilegeTreeSetting = {
		check: {
			enable: true,
			chkboxType: { Y : "ps", N : "s" }	// 父子关联关系：被勾选时—关联父，关联子;取消勾选时—不关联父，关联子
		},
		async: {
			enable: true,
			url: "system/menu/getPrivilegeNodesByRoleId/0",
			dataFilter: ajaxDataFilter,
			autoParam: ["name", "id","lft","rgt","level"]
		}
	};
	$.fn.zTree.init($("#privilegeTreeUl"), privilegeTreeSetting);
	var privilegeTree = $.fn.zTree.getZTreeObj("privilegeTreeUl");
	//分配权限
	$("#privilegeAssignBtn").click(function() {
		var checkedTreeNodes = privilegeTree.getCheckedNodes();
		var checkedMenus = [];
		var checkedPrivileges = [];
		var i = 0;
		var j = 0;
		$.each(checkedTreeNodes,function(index,value){
			if(value.lft){
				checkedMenus[i] = value.id;
				i++;
			}else{
				checkedPrivileges[j] = value.id;
				j++;
			}
		});

		var unCheckedTreeNodes = privilegeTree.getCheckedNodes(false);
		var unCheckedMenus = [];
		var unCheckedPrivileges = [];
		i = 0;
		j = 0;
		$.each(unCheckedTreeNodes,function(index,value){
			if(value.lft){
				unCheckedMenus[i] = value.id;
				i++;
			}else{
				unCheckedPrivileges[j] = value.id;
				j++;
			}
		});

		var url = "system/role/assignPrivilege";
		$.dolpPost(url,{roleId:roleId,checkedMenus:checkedMenus,checkedPrivileges:checkedPrivileges,unCheckedMenus:unCheckedMenus,unCheckedPrivileges:unCheckedPrivileges},function(returnData){
			$("#privilegeInfoCancelbtn").click();
		});
	});

	$("#privilegeInfoCancelbtn").click(function() {
		$('#privilegeInfo').dialog( "close" );
	});
});
</script>

<table id="roleList"></table>
<div id="rolePager"></div>

<div id="privilegeInfo" title="权限信息">
	<p align="center">
		<input type="button" value="分配" id="privilegeAssignBtn"/>
		&nbsp;&nbsp;&nbsp;
		<input type="button" value="取消" id='privilegeInfoCancelbtn'/>
	</p>
	<div>
		<ul id="privilegeTreeUl" class="ztree"></ul>
	</div>
</div>