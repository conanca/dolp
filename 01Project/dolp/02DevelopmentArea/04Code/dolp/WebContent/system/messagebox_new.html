<link href="wysiwygeditor/jquery.wysiwyg.css" rel="stylesheet" type="text/css"/>
<script charset="utf-8" src="wysiwygeditor/jquery.wysiwyg.js"></script>
<script type="text/javascript">
$(function(){
	$("input:button,input:submit,input:reset").button();
	
	// 初始化编辑器
	$('#messageNewEditor').wysiwyg();

	//初始化用户信息界面
	$("#messageNewUserSelect").dialog({width: 500 , hide: 'slide' , modal: true , autoOpen: false});

	//设置Grid
	$("#messageNewUserInfoList").jqGrid({
		jsonReader:{
			repeatitems: false
		},
		caption: "选择收件人列表",
		url:'system/user/getGridData',
		colNames:['id','登录号', '姓名','性别','年龄','生日','电话号码'],
		colModel:[
			{name:'id',index:'id', width:0,hidden:true},
			{name:'number',index:'number', width:100},
			{name:'name',index:'name', width:100},
			{name:'gender',index:'gender', width:100,edittype:'select', formatter:'select', editoptions:{value:genders1}},
			{name:'age',index:'age', width:100, editable:true,hidden:true},
			{name:'birthday',index:'birthday', width:100,hidden:true},
			{name:'phone',index:'phone', width:150}
		],
		pager: '#messageNewUserInfoPager',
		sortname: 'number',
		sortorder: "asc",
		multiselect: true
	});
	//不显示jqgrid自带的增删改查按钮
	$("#messageNewUserInfoList").setJqGridCUD('#messageNewUserInfoPager',{edit:false,add:false,del:false,search:false});

	//查询按钮点击事件
	$("#messageNewUserInfo_search_btn").click(function () { 
		var number = $("#messageNewUserInfo_search_number").val();
		var name = $("#messageNewUserInfo_search_name").val();
		url = "system/user/getGridData?number="+number+"&name="+name;
		$("#messageNewUserInfoList").setGridParam({url:url, page:1}).trigger("reloadGrid");
	});

	// 打开选择用户界面
	$("#messageNewReceiver").click(function() {
		$("#messageNewUserInfoList").trigger("reloadGrid");
		$("#messageNewUserSelect").dialog( "open" );
	});

	// 选择按钮点击事件
	$("#messageNewUserSelectBtn").click(function() {
		var selIds = $("#messageNewUserInfoList").getGridParam('selarrrow');
		if( selIds != null && selIds != ''){
			var receiverUserNames = $('#messageNewReceiverUsers').val();
			$.each(selIds, function(index, selId) {
				var row = $("#messageNewUserInfoList").getRowData(selId)
				var number = row.number;
				var name = row.name;
				receiverUserNames+=name+"<"+number+">,";
			});
			$('#messageNewReceiverUsers').val(receiverUserNames);
			$("#messageNewUserCloseBtn").click();
		}else{
			$.addMessageStr(null,"请选择收件人",null);
		}
	});

	// 关闭按钮点击事件
	$("#messageNewUserCloseBtn").click(function() {
		$("#messageNewUserSelect").dialog( "close" );
	});

	// 验证
	$("#messageNewForm").validate({
		rules: {
			receiverUsers: {
				required: true
			},
			title: {
				required: true,
				maxlength: 100
			},
			content: {
				required: true,
				maxlength: 1000
			}
		},
		errorPlacement: function(error, element) {
			$('<br/>').appendTo(element.parent());
			error.appendTo(element.parent());
		}
	});

	// 发送按钮点击事件
	$("#messageNewSend").click(function(){
		var url = 'system/message/sendMessage';
		messageNewSaveOrSendMessage(url);
	});
	// 保存草稿按钮点击事件
	$("#messageNewSave").click(function(){
		var url = 'system/message/saveMessage';
		messageNewSaveOrSendMessage(url);
	});
	// 上传按钮点击事件
	$("#messageNewAttachmentUploadBtn").click(function() {
		$("#messageNewAttachmentInput").dolpUpload('system/message/uploadAttachment',{},function(returnData){
			var id = returnData.id;
			var name = returnData.name;
			var nameP = "'" + name + "'";
			$('#tmpAttachmentLinks').append('<div name="' + id
					+ '"><a style="float:left" target="_blank" href="system/message/downloadAttachment?id=' + id
					+ '&name=' + name + '">' + name
					+ '</a><span class="ui-icon ui-icon-trash" style="cursor:pointer" onclick="removeAttachment(' + id + ',' + nameP + ');"></span></div>');
			var optionId = '"messageNewAttachmentsOption' + id + '"';
			var optionValue = id + "=" + name;
			$('#messageNewAttachments').append('<option selected="selected" value="' + optionValue + '">');
		});
	});
});

// 保存草稿或发送消息
function messageNewSaveOrSendMessage(url){
	if($("#messageNewForm").valid()){
		var messageNewFormInfo = $("#messageNewForm").serializeObject();
		$.dolpPost(url,messageNewFormInfo);
		$('#messageNewForm')[0].reset();
		// 删除页面上显示的附件
		$('#tmpAttachmentLinks').empty();
		$('#messageNewAttachments').empty();
	}else{
		$.addMessageStr(null,"未通过验证",null);
	}
}

// 删除附件文件
function removeAttachment(id,name){
	var url = 'system/message/removeAttachment?id=' + id + '&name=' + name;
	$.dolpPost(url);
	$('div[name="'+id+'"]').remove();
	var optionValue = id + "=" + name;
	$('option[value="' + optionValue + '"]').remove();
}
</script>

<input type="button" value="发送" id="messageNewSend"/>
<input type="button" value="保存草稿" id="messageNewSave"/>
<br/>
<form id="messageNewForm" action="#">
	<p><a href="#" id="messageNewReceiver">收件人：</a><textarea name="receiverUsers" rows="2" style="width:91%;" id="messageNewReceiverUsers"/></textarea></p>
	<p>主&nbsp;&nbsp;&nbsp;题：<input type="text" name="title" style="width:91%;"/></p>
	<p><textarea name="content" style="width:94.5%;height:100%;" id="messageNewEditor"> </textarea></p>
	<select multiple="multiple" style="display:none" name="attachments[]" id="messageNewAttachments"></select>
</form>
附件:<input type="file" name=messageAttachment id="messageNewAttachmentInput"/><button id="messageNewAttachmentUploadBtn">上传</button><br/>
<div id="tmpAttachmentLinks">
</div>

<div id="messageNewUserSelect" title="用户列表">
	<fieldset>
	<legend>用户查询</legend>
	<table>
		<tr>
			<td>
				编号：
			</td>
			<td>
				<input type="text" name="number" id="messageNewUserInfo_search_number"/>
			</td>
			<td>
				姓名：
			</td>
			<td>
				<input type="text" name="name" id="messageNewUserInfo_search_name"/>
			</td>
		</tr>
		<tr>
			<td colspan="4" align="right">
				<input type="button" id="messageNewUserInfo_search_btn" value="查询"/>
			</td>
		</tr>
	</table>
	</fieldset>
	<br/>
	<table id="messageNewUserInfoList"></table>
	<div id="messageNewUserInfoPager"></div>
	<br/>
	<div align="right">
		<input type="button" id="messageNewUserSelectBtn" value="选择"/>
		<input type="button" id="messageNewUserCloseBtn" value="关闭"/>
	</div>
</div>